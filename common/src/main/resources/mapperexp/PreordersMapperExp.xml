<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.cqjtu.mapperexp.PreordersMapperExp">


    <resultMap id="selectPreorders" type="com.cqjtu.modelexp.PreorderExp">
        <association property="preOrders" javaType="com.cqjtu.model.PreOrders">
            <result property="orderId" column="order_id"></result>
            <result property="appointmentStatusId" column="appointment_status_id"></result>
            <result property="createTime" column="create_time"></result>
            <result property="cancelTime" column="cancel_time"></result>
            <result property="finishTime" column="finish_time"></result>
            <result property="doctorId" column="doctor_id"></result>
            <result property="preorderTime" column="preorder_time"></result>
            <result property="userId" column="user_id"></result>
            <result property="branchId" column="branch_id"></result>
        </association>
        <association property="doctor" javaType="com.cqjtu.model.Doctor">
            <result property="idCard" column="doctor_id"></result>
            <result property="name" column="dname"></result>
            <result property="phone" column="phone"></result>
        </association>
        <association property="branch" javaType="com.cqjtu.model.Branch">
            <result property="branchId" column="branch_id"></result>
            <result property="name" column="name"></result>
        </association>
        <association property="preorderStatus" javaType="com.cqjtu.model.PreorderStatus">
            <result property="appointmentStatusId" column="appointment_status_id"></result>
            <result property="description" column="description"></result>
        </association>
    </resultMap>

    <select id="select" resultMap="selectPreorders" parameterType="com.cqjtu.model.PreOrders">
        SELECT order_id,preorders.appointment_status_id,create_time,cancel_time,finish_time,
        doctor_id,preorder_time,user_id,preorders.branch_id , branch.name ,
        doctor.name as dname , doctor.phone ,
        description
        from preorders
        left  join doctor on doctor_id = doctor.id_card
        left  join  branch on preorders.branch_id = branch.branch_id
        left join preorder_status on preorder_status.appointment_status_id = preorders.appointment_status_id
        <where>
            <trim prefixOverrides="and">
                <if test="orderId != null ">
                    and  order_id LIKE  CONCAT(CONCAT('%', #{orderId}), '%')
                </if>
                <if test="appointmentStatusId != null ">
                    and   appointment_status_id = #{appointmentStatusId}
                </if>
                <if test="createTime != null ">
                    and   create_time = #{createTime}
                </if>
                <if test="cancelTime != null ">
                    and   cancle_time =#{cancleTime}
                </if>
                <if test="finishTime != null ">
                    and   finish_time =#{finishTime}
                </if>
                <if test="doctorId != null ">
                    and   doctor_id = #{doctorId}
                </if>
                <if test="preorderTime != null ">
                    and   preorder_time = #{preorderTime}
                </if>
                <if test="userId != null ">
                    and   user_id =#{userId}
                </if>
                <if test="branchId != null ">
                    and   branch_id =#{branchId}
                </if>
            </trim>
        </where>
    </select>



    <insert id="insert" parameterType="com.cqjtu.model.PreOrders">
        insert into preorders
        <trim prefix="(" suffixOverrides="," suffix=")">
            <if test="null != orderId">
                order_id,
            </if>
            <if test="null != appointmentStatusId">
                appointment_status_id,
            </if>
            create_time,
            <if test="null != preorderTime">
                preorder_time,
            </if>

            <if test="null != doctorId">
                doctor_id,
            </if>
            <if test="null != userId">
                user_id,
            </if>
            <if test="null != branchId">
                branch_id,
            </if>
        </trim>
        VALUES
        <trim prefix="(" suffixOverrides="," suffix=")">
            <if test="null != orderId">
                #{orderId},
            </if>
            <if test="null != appointmentStatusId">
                ${appointmentStatusId},
            </if>
            now(),
            <if test="null != preorderTime">
                #{preorderTime},
            </if>
            <if test="null != doctorId">
                "${doctorId}",
            </if>
            <if test="null != userId">
                #{userId},
            </if>
            <if test="null != branchId">
                #{branchId},
            </if>
        </trim>
    </insert>

    <update id="updateCancleTime"  parameterType="com.cqjtu.model.PreOrders">
        UPDATE preorders
        set
        cancel_time = now(),
        appointment_status_id = 2
        where
        order_id = #{orderId}  and appointment_status_id = 1
        and (doctor_id = #{doctorId} or  user_id = #{userId})
    </update>


    <update id="updateFinishTime"  parameterType="com.cqjtu.model.PreOrders">
        UPDATE preorders
        set
        finish_time = now() ,
        appointment_status_id = 3
        where
        order_id = #{orderId} and appointment_status_id = 1
        and doctor_id = #{doctorId}
    </update>

</mapper>